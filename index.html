<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Rateio Senac - Gestão</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- SheetJS (Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Estilos Extras -->
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; color: white; animation: slideUp 0.3s ease-out; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .toast-success { background-color: #10b981; }
        .toast-error { background-color: #ef4444; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Tabela compacta */
        .table-tiny td, .table-tiny th { padding: 6px 8px; font-size: 0.85rem; vertical-align: middle; }
        
        /* Estilo para impressão/cópia */
        .print-area { background: white; padding: 30px; border: 1px solid #e2e8f0; border-radius: 8px; }
        
        /* Esconder input file */
        .hidden-input { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // =================================================================================
        // CONFIGURAÇÃO
        // =================================================================================
        
        const LINK_FIXO_DO_EXCEL = "https://github.com/Supervisao-pratica/Rateio/raw/refs/heads/main/RATEIO.xlsm"; 
        const LOGO_SENAC = "https://upload.wikimedia.org/wikipedia/commons/8/86/Senac_logo.svg"; 

        // Constantes de Relatório
        const INFO_DESLOCAMENTO = { uept: 27, tept: 5956, evento: 3 };
        const INFO_ATENDIMENTO = { uept: 27, tept: 5956, evento: 24 };

        // =================================================================================

        // Ícones
        const IconWrapper = ({ children, size = 18, className="" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Save = (p) => <IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>;
        const Trash2 = (p) => <IconWrapper {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconWrapper>;
        const Car = (p) => <IconWrapper {...p}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M2 12h12"/></IconWrapper>;
        const Users = (p) => <IconWrapper {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconWrapper>;
        const Upload = (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconWrapper>;
        const Database = (p) => <IconWrapper {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconWrapper>;
        const Mail = (p) => <IconWrapper {...p}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></IconWrapper>;
        const Plus = (p) => <IconWrapper {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconWrapper>;
        const MapPin = (p) => <IconWrapper {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></IconWrapper>;
        const Clipboard = (p) => <IconWrapper {...p}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></IconWrapper>;
        const X = (p) => <IconWrapper {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconWrapper>;
        const Home = (p) => <IconWrapper {...p}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconWrapper>;
        const Coffee = (p) => <IconWrapper {...p}><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></IconWrapper>;
        const FileUp = (p) => <IconWrapper {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="M9 15l3-3 3 3"/></IconWrapper>;

        const Card = ({ children, className = "" }) => (<div className={`bg-white rounded-xl shadow-sm border border-gray-100 p-6 ${className}`}>{children}</div>);
        
        // Utilitários
        const calculateDuration = (start, end) => { 
            if (!start || !end) return 0; 
            const [startH, startM] = start.split(':').map(Number); 
            const [endH, endM] = end.split(':').map(Number); 
            let diff = new Date(0, 0, 0, endH, endM) - new Date(0, 0, 0, startH, startM); 
            if (diff < 0) diff += 86400000; 
            return diff / 3600000; 
        };
        const formatHours = (decimalHours) => { 
            const h = Math.floor(decimalHours); 
            const m = Math.round((decimalHours - h) * 60); 
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`; 
        };
        const formatDatePT = (dateString) => {
            if(!dateString) return "";
            const [y, m, d] = dateString.split('-');
            return `${d}/${m}/${y}`;
        };

        function App() {
            const [activeTab, setActiveTab] = useState('visitas');
            const [toast, setToast] = useState(null);
            
            // Estado do Modal de Relatório
            const [reportModalOpen, setReportModalOpen] = useState(false);
            const [reportType, setReportType] = useState('visitas'); 
            const reportRef = useRef(null);

            // Dados
            const [costCenters, setCostCenters] = useState([]);
            const [visits, setVisits] = useState([]); 
            const [adminEntries, setAdminEntries] = useState([]);
            
            // Estado para Inclusão Manual de CC
            const [manualCC, setManualCC] = useState({ turma: '', codigo: '' });

            // Estado para o "Roteiro do Dia"
            const [routeDate, setRouteDate] = useState('');
            const [startPoint, setStartPoint] = useState({ city: '', time: '' });
            const [stops, setStops] = useState([]);
            const [returnPoint, setReturnPoint] = useState({ city: '', time: '', ccId: '' });
            
            // Estado para Almoço
            const [lunch, setLunch] = useState({ start: '', end: '' });

            const [newAdmin, setNewAdmin] = useState({ data: '', turma: '', atividade: '', inicio: '', fim: '', supervisor: '' });

            const showToast = (msg, type='success') => { setToast({msg, type}); setTimeout(() => setToast(null), 3000); };

            useEffect(() => {
                const init = async () => {
                   if (LINK_FIXO_DO_EXCEL && !LINK_FIXO_DO_EXCEL.includes("SEU_USUARIO")) {
                       try {
                           const resp = await fetch(LINK_FIXO_DO_EXCEL.replace("github.com", "raw.githubusercontent.com").replace("/blob/", "/").replace("/raw/", "/"));
                           if(resp.ok) {
                               const ab = await resp.arrayBuffer();
                               const wb = XLSX.read(ab, { type: 'array' });
                               processWorkbook(wb, 'auto');
                           }
                       } catch(e) { console.log("Erro auto load", e); }
                   }
                };
                init();
            }, []);

            const processWorkbook = (wb, source) => {
                let counts = { cc: 0 };
                
                // 1. Processar CCs com DEDUPLICAÇÃO
                if (wb.SheetNames.some(n => n.includes("CC"))) {
                    const ws = wb.Sheets[wb.SheetNames.find(n => n.includes("CC"))];
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    const mapped = [];
                    const seenTurmas = new Set(); 
                    
                    for(let i=1; i < data.length; i++) {
                        const row = data[i];
                        if(row && row.length >= 2) {
                            const turma = String(row[0]).trim();
                            const codigo = String(row[1]).trim();
                            const desc = row[2] || '';
                            
                            if(turma && codigo) {
                                if (!seenTurmas.has(turma)) {
                                    mapped.push({ id: i, turma: turma, codigo: codigo, descricao: String(desc).trim() });
                                    seenTurmas.add(turma);
                                }
                            }
                        }
                    }
                    if(mapped.length > 0) {
                        setCostCenters(prev => {
                            const existingIds = new Set(prev.map(p => p.turma));
                            const newUnique = mapped.filter(m => !existingIds.has(m.turma));
                            return [...prev, ...newUnique];
                        });
                        counts.cc = mapped.length;
                    }
                }

                if (source === 'manual') showToast(`Sucesso! Planilha processada.`);
            };

            const handleManualUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const wb = XLSX.read(evt.target.result, { type: 'binary' });
                    processWorkbook(wb, 'manual');
                };
                reader.readAsBinaryString(file);
            };
            
            // --- NOVA FUNÇÃO: Upload Genérico (Coluna A=Turma, Coluna B=CC) ---
            const handleGenericCCUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        // Ler como binário para compatibilidade total
                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                        // Pega sempre a primeira aba
                        const ws = wb.Sheets[wb.SheetNames[0]]; 
                        const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                        
                        const newCCs = [];
                        
                        data.forEach((row, index) => {
                            // Ignora linhas vazias
                            if (row.length >= 2) {
                                const turma = String(row[0]).trim();
                                const codigo = String(row[1]).trim();
                                
                                // Validação simples para pular cabeçalhos óbvios (se tiver "Turma" na coluna A)
                                if (turma && codigo && turma.toLowerCase() !== 'turma' && codigo.toLowerCase() !== 'cc' && codigo.toLowerCase() !== 'centro de custo') {
                                    newCCs.push({
                                        id: Date.now() + index, // ID único
                                        turma: turma,
                                        codigo: codigo,
                                        descricao: 'Importado Lista Simples'
                                    });
                                }
                            }
                        });

                        if (newCCs.length > 0) {
                            setCostCenters(prev => {
                                // Evita duplicatas pela Turma
                                const existingTurmas = new Set(prev.map(c => c.turma));
                                const filtered = newCCs.filter(c => !existingTurmas.has(c.turma));
                                return [...prev, ...filtered];
                            });
                            showToast(`${newCCs.length} Turmas/CCs importados com sucesso!`);
                        } else {
                            showToast("Nenhum dado válido encontrado (Col A: Turma, Col B: CC).", "error");
                        }
                    } catch (err) {
                        console.error(err);
                        showToast("Erro ao ler arquivo. Verifique o formato.", "error");
                    }
                };
                reader.readAsBinaryString(file);
            };

            const addManualCC = () => {
                if (!manualCC.turma || !manualCC.codigo) {
                    return alert("Preencha Turma e Código do CC.");
                }
                
                setCostCenters(prev => {
                    if (prev.some(cc => cc.turma === manualCC.turma)) {
                        alert("Esta turma já está cadastrada!");
                        return prev;
                    }
                    showToast("CC adicionado com sucesso!");
                    return [...prev, {
                        id: Date.now(),
                        turma: manualCC.turma,
                        codigo: manualCC.codigo,
                        descricao: 'Manual'
                    }];
                });
                setManualCC({ turma: '', codigo: '' });
            };

            const triggerUpload = () => {
                document.getElementById('fileUpload').click();
            };
            
            const triggerGenericUpload = () => {
                document.getElementById('genericCCUpload').click();
            };

            const addStop = () => setStops([...stops, { id: Date.now(), city: '', arrival: '', departure: '', ccId: '' }]);
            const removeStop = (id) => setStops(stops.filter(s => s.id !== id));
            const updateStop = (id, field, value) => setStops(stops.map(s => s.id === id ? { ...s, [field]: value } : s));

            const saveRoute = () => {
                if (!routeDate || !startPoint.city || !startPoint.time) return alert("Preencha data e partida.");
                if (returnPoint.city && !returnPoint.time) return alert("Preencha o horário de chegada do retorno.");

                const newEntries = [];
                let lastCity = startPoint.city;
                let lastTime = startPoint.time;

                // Processar Almoço
                if (lunch.start || lunch.end) {
                    if (!lunch.start || !lunch.end) return alert("Preencha o horário de saída e retorno do almoço.");
                    const lunchDuration = calculateDuration(lunch.start, lunch.end);
                    if (lunchDuration < 0.99) {
                        return alert("O intervalo de descanso/almoço deve ser de no mínimo 1 hora!");
                    }
                    newEntries.push({
                        id: Date.now() + Math.random(),
                        type: 'descanso',
                        data: routeDate,
                        local: 'Intervalo de Almoço',
                        inicio: lunch.start,
                        fim: lunch.end,
                        turma: '',
                        horas: lunchDuration
                    });
                }

                stops.forEach(stop => {
                    if (!stop.city || !stop.arrival || !stop.ccId) return;
                    
                    const travelTime = calculateDuration(lastTime, stop.arrival);
                    if (travelTime > 0) {
                        newEntries.push({
                            id: Date.now() + Math.random(),
                            type: 'deslocamento',
                            data: routeDate,
                            origem: lastCity,
                            destino: stop.city,
                            inicio: lastTime,
                            fim: stop.arrival,
                            turma: stop.ccId,
                            horas: travelTime
                        });
                    }
                    
                    if (stop.departure) {
                        const workTime = calculateDuration(stop.arrival, stop.departure);
                        if (workTime > 0) {
                            newEntries.push({
                                id: Date.now() + Math.random(),
                                type: 'atendimento',
                                data: routeDate,
                                local: stop.city,
                                inicio: stop.arrival,
                                fim: stop.departure,
                                turma: stop.ccId,
                                horas: workTime
                            });
                        }
                        lastTime = stop.departure;
                    } else {
                        lastTime = stop.arrival; 
                    }
                    lastCity = stop.city;
                });

                if (returnPoint.city && returnPoint.time) {
                    const returnTime = calculateDuration(lastTime, returnPoint.time);
                    if (returnTime > 0) {
                        newEntries.push({
                            id: Date.now() + Math.random(),
                            type: 'deslocamento',
                            data: routeDate,
                            origem: lastCity,
                            destino: returnPoint.city,
                            inicio: lastTime,
                            fim: returnPoint.time,
                            turma: returnPoint.ccId || stops[stops.length-1]?.ccId || '', 
                            horas: returnTime
                        });
                    }
                }

                newEntries.sort((a, b) => {
                    const timeA = parseInt(a.inicio.replace(':', ''));
                    const timeB = parseInt(b.inicio.replace(':', ''));
                    return timeA - timeB;
                });

                setVisits([...visits, ...newEntries]);
                showToast(`${newEntries.length} lançamentos gerados!`);
                setStops([]);
                setStartPoint({ city: '', time: '' });
                setReturnPoint({ city: '', time: '', ccId: '' });
                setLunch({ start: '', end: '' }); 
            };

            const addAdmin = () => {
                if (!newAdmin.turma || !newAdmin.data) return alert("Preencha dados obrigatórios");
                setAdminEntries([...adminEntries, { ...newAdmin, id: Date.now() }]);
                setNewAdmin({ ...newAdmin, inicio: '', fim: '' });
                showToast("Admin salvo!");
            };

            const copyReportToClipboard = () => {
                if (!reportRef.current) return;
                const range = document.createRange();
                range.selectNode(reportRef.current);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                try {
                    document.execCommand('copy');
                    showToast("Copiado! Cole no Outlook.");
                } catch (err) { alert("Erro ao copiar."); }
                window.getSelection().removeAllRanges();
            };

            const ReportModal = () => {
                if (!reportModalOpen) return null;
                const today = new Date().toLocaleDateString('pt-BR');
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col">
                            <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                                <h3 className="font-bold text-lg text-gray-800">Visualizar Relatório para E-mail</h3>
                                <button onClick={() => setReportModalOpen(false)}><X className="text-gray-500 hover:text-red-500" /></button>
                            </div>
                            
                            <div className="p-6 overflow-y-auto bg-gray-100">
                                <div ref={reportRef} className="print-area font-sans text-gray-800 bg-white">
                                    <div className="senac-header" style={{borderBottom: '2px solid #f97316', paddingBottom: '15px', marginBottom: '20px'}}>
                                        <div>
                                            <h2 style={{fontSize: '24px', fontWeight: 'bold', color: '#004587', margin: 0}}>Relatório de Atividades</h2>
                                            <p style={{color: '#666', margin: 0, fontSize: '14px'}}>Data de Emissão: {today}</p>
                                        </div>
                                        <img src={LOGO_SENAC} alt="Senac" style={{height: '45px'}} />
                                    </div>

                                    {reportType === 'visitas' && (
                                        <div>
                                            <h3 style={{color: '#f97316', fontWeight: 'bold', borderBottom: '1px solid #eee', paddingBottom: '5px'}}>Resumo de Roteiros e Visitas</h3>
                                            <table style={{width: '100%', borderCollapse: 'collapse', marginTop: '10px', fontSize: '12px'}}>
                                                <thead>
                                                    <tr style={{backgroundColor: '#004587', color: 'white'}}>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Data</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Tipo / Info Senac</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Detalhes</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Horários</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Turma/CC</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a', textAlign: 'right'}}>Horas</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {visits.map((v, i) => {
                                                        const cc = costCenters.find(c => c.id == v.turma);
                                                        const ccCodigo = cc ? cc.codigo : (v.type === 'descanso' ? '-' : '-');
                                                        const turmaNome = cc ? cc.turma : (v.type === 'descanso' ? '-' : 'N/A');
                                                        const rowBg = i % 2 === 0 ? '#ffffff' : '#f8fafc';
                                                        
                                                        if (v.type === 'descanso') {
                                                            return (
                                                                <tr key={i} style={{backgroundColor: '#f3f4f6', color: '#6b7280'}}>
                                                                    <td style={{padding: '8px', border: '1px solid #e2e8f0'}}>{formatDatePT(v.data)}</td>
                                                                    <td style={{padding: '8px', border: '1px solid #e2e8f0', fontWeight: 'bold'}}>DESCANSO</td>
                                                                    <td style={{padding: '8px', border: '1px solid #e2e8f0'}}>Intervalo de Almoço</td>
                                                                    <td style={{padding: '8px', border: '1px solid #e2e8f0', whiteSpace:'nowrap'}}>Início: {v.inicio}<br/>Fim: {v.fim}</td>
                                                                    <td style={{padding: '8px', border: '1px solid #e2e8f0', textAlign: 'center'}}>-</td>
                                                                    <td style={{padding: '8px', border: '1px solid #e2e8f0', textAlign: 'right'}}>{formatHours(v.horas)}</td>
                                                                </tr>
                                                            );
                                                        }

                                                        const info = v.type === 'deslocamento' ? INFO_DESLOCAMENTO : INFO_ATENDIMENTO;
                                                        return (
                                                            <tr key={i} style={{backgroundColor: rowBg}}>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0'}}>{formatDatePT(v.data)}</td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0'}}>
                                                                    <div style={{fontWeight:'bold', color: v.type==='deslocamento'?'#d97706':'#15803d'}}>{v.type.toUpperCase()}</div>
                                                                    <div style={{fontSize:'10px', color:'#555', marginTop:'4px'}}>UEPT: {info.uept} | TEPT: {info.tept}<br/>Evento: <b>{info.evento}</b></div>
                                                                </td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0'}}>{v.type === 'deslocamento' ? <span>{v.origem} &#10140; {v.destino}</span> : <span>Atend. em {v.local}</span>}</td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0', whiteSpace:'nowrap'}}>{v.type === 'deslocamento' ? <div>Saída: {v.inicio}<br/>Chegada: {v.fim}</div> : <div>Início: {v.inicio}<br/>Fim: {v.fim}</div>}</td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0'}}><div>{turmaNome}</div><div style={{fontFamily: 'monospace', fontWeight: 'bold', color:'#004587'}}>{ccCodigo}</div></td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0', textAlign: 'right', fontWeight: 'bold'}}>{formatHours(v.horas)}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}

                                    {reportType === 'admin' && (
                                        <div>
                                            <h3 style={{color: '#f97316', fontWeight: 'bold', borderBottom: '1px solid #eee', paddingBottom: '5px'}}>Lançamentos Administrativos</h3>
                                            <table style={{width: '100%', borderCollapse: 'collapse', marginTop: '10px', fontSize: '12px'}}>
                                                <thead>
                                                    <tr style={{backgroundColor: '#004587', color: 'white'}}>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Data</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Info Senac</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Atividade</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Horários</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Turma/CC</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a', textAlign: 'right'}}>Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {adminEntries.map((a, i) => {
                                                        const cc = costCenters.find(c => c.turma === a.turma);
                                                        const ccCodigo = cc ? cc.codigo : '-';
                                                        const rowBg = i % 2 === 0 ? '#ffffff' : '#f8fafc';
                                                        return (
                                                            <tr key={i} style={{backgroundColor: rowBg}}>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0'}}>{formatDatePT(a.data)}</td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0', fontSize:'10px', color:'#555'}}>UEPT: {INFO_ATENDIMENTO.uept} | TEPT: {INFO_ATENDIMENTO.tept}<br/>Evento: <b>{INFO_ATENDIMENTO.evento}</b></td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0'}}>{a.atividade}</td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0', whiteSpace:'nowrap'}}>Início: {a.inicio}<br/>Fim: {a.fim}</td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0'}}><div>{a.turma}</div><div style={{fontFamily: 'monospace', fontWeight: 'bold', color:'#004587'}}>{ccCodigo}</div></td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0', textAlign: 'right', fontWeight: 'bold'}}>{formatHours(calculateDuration(a.inicio, a.fim))}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="p-4 border-t bg-white rounded-b-xl flex justify-end gap-3">
                                <button onClick={() => setReportModalOpen(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Fechar</button>
                                <button onClick={copyReportToClipboard} className="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 flex items-center gap-2 shadow-md"><Clipboard size={18} /> Copiar para Outlook</button>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderVisitas = () => (
                <div className="space-y-6">
                    <Card className="border-l-4 border-blue-500">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg flex items-center gap-2"><MapPin className="text-blue-600"/> Criador de Roteiro Diário</h3>
                            <input type="date" className="p-2 border rounded font-bold text-gray-700" value={routeDate} onChange={e => setRouteDate(e.target.value)} />
                        </div>
                        <div className="p-4 bg-gray-50 rounded-lg mb-4 border border-gray-200">
                            <h4 className="text-xs font-bold text-gray-500 uppercase mb-2">1. Ponto de Partida</h4>
                            <div className="grid grid-cols-2 gap-4">
                                <input type="text" placeholder="Cidade Origem" className="p-2 border rounded" value={startPoint.city} onChange={e => setStartPoint({...startPoint, city: e.target.value})} />
                                <input type="time" className="p-2 border rounded" value={startPoint.time} onChange={e => setStartPoint({...startPoint, time: e.target.value})} />
                            </div>
                        </div>
                        <div className="space-y-3 mb-4">
                            {stops.map((stop, idx) => (
                                <div key={stop.id} className="p-4 bg-white border border-blue-100 rounded-lg shadow-sm relative">
                                    <div className="absolute -left-3 top-1/2 -translate-y-1/2 bg-blue-100 text-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">{idx+1}</div>
                                    <button onClick={() => removeStop(stop.id)} className="absolute top-2 right-2 text-red-400 hover:text-red-600"><Trash2 size={16}/></button>
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                        <div><label className="text-xs text-gray-500">Cidade Destino</label><input type="text" className="w-full p-2 border rounded" value={stop.city} onChange={e => updateStop(stop.id, 'city', e.target.value)} /></div>
                                        <div><label className="text-xs text-gray-500">Chegada</label><input type="time" className="w-full p-2 border rounded" value={stop.arrival} onChange={e => updateStop(stop.id, 'arrival', e.target.value)} /></div>
                                        <div><label className="text-xs text-gray-500">Saída (Fim atend.)</label><input type="time" className="w-full p-2 border rounded" value={stop.departure} onChange={e => updateStop(stop.id, 'departure', e.target.value)} /></div>
                                        <div>
                                            <label className="text-xs text-gray-500">Turma/CC</label>
                                            <select className="w-full p-2 border rounded text-sm" value={stop.ccId} onChange={e => updateStop(stop.id, 'ccId', e.target.value)}>
                                                <option value="">Selecione...</option>
                                                {costCenters.length === 0 && <option value="" disabled>Nenhum CC Cadastrado</option>}
                                                {costCenters.map(cc => (<option key={cc.id} value={cc.id}>{cc.turma} - {cc.codigo}</option>))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            ))}
                            <button onClick={addStop} className="w-full py-2 border-2 border-dashed border-blue-300 text-blue-600 rounded-lg hover:bg-blue-50 font-semibold flex justify-center items-center gap-2"><Plus size={18}/> Adicionar Parada/Atendimento</button>
                        </div>
                        <div className="p-4 bg-gray-100 rounded-lg mb-4 border border-gray-300">
                            <h4 className="text-xs font-bold text-gray-600 uppercase mb-2 flex items-center gap-1"><Coffee size={14}/> Intervalo de Almoço / Descanso (Mínimo 1h)</h4>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs text-gray-500">Saída para Almoço</label><input type="time" className="w-full p-2 border rounded" value={lunch.start} onChange={e => setLunch({...lunch, start: e.target.value})} /></div>
                                <div><label className="text-xs text-gray-500">Retorno do Almoço</label><input type="time" className="w-full p-2 border rounded" value={lunch.end} onChange={e => setLunch({...lunch, end: e.target.value})} /></div>
                            </div>
                        </div>
                        <div className="p-4 bg-orange-50 rounded-lg mb-4 border border-orange-200">
                            <h4 className="text-xs font-bold text-orange-600 uppercase mb-2 flex items-center gap-1"><Home size={14}/> Retorno à Base / Final (Apenas Deslocamento)</h4>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label className="text-xs text-gray-500">Cidade Final</label><input type="text" className="w-full p-2 border rounded" value={returnPoint.city} onChange={e => setReturnPoint({...returnPoint, city: e.target.value})} /></div>
                                <div><label className="text-xs text-gray-500">Chegada</label><input type="time" className="w-full p-2 border rounded" value={returnPoint.time} onChange={e => setReturnPoint({...returnPoint, time: e.target.value})} /></div>
                                <div>
                                    <label className="text-xs text-gray-500">CC do Deslocamento (Opcional)</label>
                                    <select className="w-full p-2 border rounded text-sm" value={returnPoint.ccId} onChange={e => setReturnPoint({...returnPoint, ccId: e.target.value})}>
                                        <option value="">Usar CC da última parada</option>
                                        {costCenters.map(cc => (<option key={cc.id} value={cc.id}>{cc.turma}</option>))}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button onClick={saveRoute} className="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold flex justify-center items-center gap-2 shadow-lg"><Save size={18}/> Salvar Roteiro Completo</button>
                    </Card>
                    <Card>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-gray-700">Histórico de Atividades</h3>
                            <button onClick={() => { setReportType('visitas'); setReportModalOpen(true); }} className="text-sm bg-orange-500 text-white px-3 py-1 rounded hover:bg-orange-600 flex items-center gap-1 shadow"><Mail size={14}/> Relatório E-mail</button>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left table-tiny">
                                <thead className="bg-gray-100 text-gray-600"><tr><th>Data</th><th>Tipo</th><th>Detalhe</th><th>Horários</th><th>Turma</th><th>CC</th><th>Horas</th><th></th></tr></thead>
                                <tbody>{visits.map(v => {
                                    if(v.type === 'descanso') {
                                        return (
                                            <tr key={v.id} className="border-b bg-gray-50 text-gray-500">
                                                <td>{formatDatePT(v.data)}</td>
                                                <td className="font-bold">DESCANSO</td>
                                                <td>Intervalo</td>
                                                <td className="text-xs whitespace-nowrap">Início: {v.inicio} Fim: {v.fim}</td>
                                                <td>-</td>
                                                <td>-</td>
                                                <td>{formatHours(v.horas)}</td>
                                                <td><button onClick={() => setVisits(visits.filter(x => x.id !== v.id))} className="text-red-400"><Trash2 size={14}/></button></td>
                                            </tr>
                                        );
                                    }
                                    const cc = costCenters.find(c => c.id == v.turma);
                                    const turma = cc ? cc.turma : 'N/A';
                                    const cod = cc ? cc.codigo : '-';
                                    return (
                                        <tr key={v.id} className="border-b hover:bg-gray-50">
                                            <td>{formatDatePT(v.data)}</td>
                                            <td>{v.type === 'deslocamento' ? <span className="text-yellow-600 font-bold text-xs">Desloc.</span> : <span className="text-green-600 font-bold text-xs">Atend.</span>}</td>
                                            <td className="text-gray-600 text-xs">{v.type === 'deslocamento' ? `${v.origem} > ${v.destino}` : v.local}</td>
                                            <td className="text-xs whitespace-nowrap">{v.type==='deslocamento' ? `Saída: ${v.inicio} Cheg: ${v.fim}` : `Início: ${v.inicio} Fim: ${v.fim}`}</td>
                                            <td className="text-xs">{turma}</td>
                                            <td className="text-xs font-mono text-blue-600">{cod}</td>
                                            <td className="font-bold text-xs">{formatHours(v.horas)}</td>
                                            <td><button onClick={() => setVisits(visits.filter(x => x.id !== v.id))} className="text-red-400"><Trash2 size={14}/></button></td>
                                        </tr>
                                    );
                                })}</tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            );

            const renderAdmin = () => (
                <div className="space-y-6">
                    <Card>
                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Users className="text-purple-600"/> Lançamento Administrativo</h3>
                        <div className="grid grid-cols-1 gap-4 mb-4">
                            <input type="date" className="p-2 border rounded" value={newAdmin.data} onChange={e => setNewAdmin({...newAdmin, data: e.target.value})} />
                            <select className="p-2 border rounded" value={newAdmin.turma} onChange={e => setNewAdmin({...newAdmin, turma: e.target.value})}>
                                <option value="">Selecione Turma...</option>
                                {costCenters.length === 0 && <option value="" disabled>Nenhum CC Cadastrado</option>}
                                {costCenters.map(cc => <option key={cc.id} value={cc.turma}>{cc.turma}</option>)}
                            </select>
                            <input type="text" placeholder="Atividade" className="p-2 border rounded" value={newAdmin.atividade} onChange={e => setNewAdmin({...newAdmin, atividade: e.target.value})} />
                            <div className="flex gap-4"><input type="time" className="p-2 border rounded flex-1" value={newAdmin.inicio} onChange={e => setNewAdmin({...newAdmin, inicio: e.target.value})} /><input type="time" className="p-2 border rounded flex-1" value={newAdmin.fim} onChange={e => setNewAdmin({...newAdmin, fim: e.target.value})} /></div>
                        </div>
                        <button onClick={addAdmin} className="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700 flex justify-center items-center gap-2"><Save size={18} /> Salvar</button>
                    </Card>
                    <Card>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-gray-700">Histórico Admin</h3>
                            <button onClick={() => { setReportType('admin'); setReportModalOpen(true); }} className="text-sm bg-orange-500 text-white px-3 py-1 rounded hover:bg-orange-600 flex items-center gap-1 shadow"><Mail size={14}/> Relatório E-mail</button>
                        </div>
                        <table className="w-full text-sm text-left"><thead className="bg-gray-100"><tr><th className="p-2">Data</th><th className="p-2">Ativ.</th><th className="p-2">Turma</th><th className="p-2">CC</th><th className="p-2">Horários</th><th className="p-2">Total</th><th></th></tr></thead>
                        <tbody>{adminEntries.map(a => {
                            const cc = costCenters.find(c => c.turma === a.turma);
                            const ccCodigo = cc ? cc.codigo : '-';
                            return (<tr key={a.id} className="border-b"><td className="p-2">{formatDatePT(a.data)}</td><td className="p-2">{a.atividade}</td><td className="p-2">{a.turma}</td><td className="p-2 font-mono text-blue-600 text-xs">{ccCodigo}</td><td className="p-2 text-xs">Início: {a.inicio} Fim: {a.fim}</td><td className="p-2 font-bold">{formatHours(calculateDuration(a.inicio, a.fim))}</td><td><button onClick={() => setAdminEntries(adminEntries.filter(x => x.id !== a.id))} className="text-red-400"><Trash2 size={14}/></button></td></tr>);
                        })}</tbody></table>
                    </Card>
                </div>
            );

            const renderCC = () => (
                <div className="space-y-6">
                    {/* Painel de Inserção */}
                    <Card>
                        <h3 className="font-bold text-lg mb-4 text-gray-800 flex items-center gap-2">
                            <Plus size={20} className="text-blue-600"/> Adicionar Centros de Custo
                        </h3>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            {/* Lado Esquerdo: Manual */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h4 className="text-sm font-bold text-gray-700 mb-3 border-b pb-2">Cadastro Manual</h4>
                                <div className="space-y-3">
                                    <div>
                                        <label className="text-xs text-gray-500 font-bold block mb-1">Número da Turma</label>
                                        <input 
                                            type="text" 
                                            className="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-300 outline-none" 
                                            placeholder="Ex: 202400123"
                                            value={manualCC.turma}
                                            onChange={e => setManualCC({...manualCC, turma: e.target.value})}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-500 font-bold block mb-1">Código CC</label>
                                        <input 
                                            type="text" 
                                            className="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-300 outline-none" 
                                            placeholder="Ex: 12345ABC"
                                            value={manualCC.codigo}
                                            onChange={e => setManualCC({...manualCC, codigo: e.target.value})}
                                        />
                                    </div>
                                    <button 
                                        onClick={addManualCC} 
                                        className="w-full bg-blue-600 text-white py-2 rounded text-sm font-bold hover:bg-blue-700 transition-colors flex justify-center items-center gap-2"
                                    >
                                        <Plus size={16}/> Adicionar
                                    </button>
                                </div>
                            </div>

                            {/* Lado Direito: Upload Genérico */}
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <h4 className="text-sm font-bold text-blue-800 mb-3 border-b border-blue-200 pb-2">Importar Lista Simples (Excel)</h4>
                                <p className="text-xs text-gray-600 mb-4">
                                    Faça upload de qualquer arquivo Excel (.xlsx, .xls, .csv). O sistema lerá a <b>1ª aba</b>:
                                    <br/>• <b>Coluna A:</b> Turma
                                    <br/>• <b>Coluna B:</b> Código CC
                                </p>
                                <button 
                                    onClick={triggerGenericUpload} 
                                    className="w-full bg-white border-2 border-blue-300 text-blue-700 py-6 rounded-lg font-bold hover:bg-blue-100 transition-all flex flex-col items-center justify-center gap-2 border-dashed"
                                >
                                    <Upload size={24}/> 
                                    <span>Selecionar Arquivo Excel</span>
                                </button>
                                <input type="file" id="genericCCUpload" accept=".xlsx,.xls,.csv" onChange={handleGenericCCUpload} className="hidden-input" />
                            </div>
                        </div>
                    </Card>

                    {/* Tabela de Listagem */}
                    <Card>
                        <h3 className="font-bold text-lg mb-4 text-gray-700 flex items-center gap-2">
                            <Database size={20} className="text-gray-500"/> Centros de Custo Cadastrados
                            <span className="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full">{costCenters.length}</span>
                        </h3>
                        <div className="overflow-x-auto max-h-96 border rounded-lg">
                            <table className="w-full text-left border-collapse text-sm">
                                <thead>
                                    <tr className="bg-gray-100 sticky top-0 z-10">
                                        <th className="p-3 border-b font-bold text-gray-600">Turma (Col A)</th>
                                        <th className="p-3 border-b font-bold text-gray-600">CC (Col B)</th>
                                        <th className="p-3 border-b font-bold text-gray-600">Origem</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {costCenters.length === 0 ? (
                                        <tr><td colSpan="3" className="p-8 text-center text-gray-400">Nenhum CC cadastrado ainda. Use as opções acima.</td></tr>
                                    ) : (
                                        costCenters.map(cc => (
                                            <tr key={cc.id} className="border-b hover:bg-gray-50 transition-colors">
                                                <td className="p-3 font-bold text-gray-800">{cc.turma}</td>
                                                <td className="p-3 font-mono text-blue-600 bg-blue-50 w-min whitespace-nowrap px-4 rounded">{cc.codigo}</td>
                                                <td className="p-3 text-gray-400 text-xs italic">{cc.descricao || '-'}</td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-50 p-4 md:p-8 font-sans text-gray-800">
                    {toast && <div className={`toast ${toast.type === 'error' ? 'toast-error' : 'toast-success'}`}>{toast.msg}</div>}
                    <ReportModal />
                    <input type="file" id="fileUpload" accept=".xlsx,.xlsm" onChange={handleManualUpload} className="hidden-input" />
                    
                    <div className="max-w-6xl mx-auto mb-6">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                            <div><h1 className="text-2xl font-bold text-gray-900">Sistema de Rateio</h1><p className="text-gray-500 text-sm">Gestão de Horas e Roteiros</p></div>
                            <div className="flex gap-2">
                                <button onClick={triggerUpload} className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center gap-2 font-bold animate-pulse"><Upload size={18} /> Importar Planilha Completa (Rateio)</button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-6xl mx-auto bg-white rounded-lg shadow-sm p-1 mb-6 flex overflow-x-auto">
                        {[{ id: 'visitas', icon: Car, label: 'Lançar Visitas' }, { id: 'admin', icon: Users, label: 'Lançar Admin' }, { id: 'cc', icon: Database, label: 'Ver CCs' }].map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 flex items-center justify-center gap-2 py-3 px-4 rounded-md transition-all whitespace-nowrap ${activeTab === tab.id ? 'bg-blue-50 text-blue-600 font-bold shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}>
                                <tab.icon size={18} /> {tab.label}
                            </button>
                        ))}
                    </div>

                    <div className="max-w-6xl mx-auto">
                        {activeTab === 'visitas' && renderVisitas()}
                        {activeTab === 'admin' && renderAdmin()}
                        {activeTab === 'cc' && renderCC()}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
