<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Rateio Senac - Final</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- SheetJS (Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Estilos Extras -->
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; color: white; animation: slideUp 0.3s ease-out; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .toast-success { background-color: #10b981; }
        .toast-error { background-color: #ef4444; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Tabela compacta */
        .table-tiny td, .table-tiny th { padding: 6px 8px; font-size: 0.85rem; vertical-align: middle; }
        
        /* Estilo para impressão/cópia */
        .print-area { background: white; padding: 30px; border: 1px solid #e2e8f0; border-radius: 8px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // =================================================================================
        // CONFIGURAÇÃO
        // =================================================================================
        
        const LINK_FIXO_DO_EXCEL = "https://github.com/Supervisao-pratica/Rateio/raw/refs/heads/main/RATEIO.xlsm"; 
        const LOGO_SENAC = "https://upload.wikimedia.org/wikipedia/commons/8/86/Senac_logo.svg"; 

        // Constantes de Relatório
        const INFO_DESLOCAMENTO = { uept: 27, tept: 5956, evento: 3 };
        const INFO_ATENDIMENTO = { uept: 27, tept: 5956, evento: 24 };

        // =================================================================================

        // Ícones
        const IconWrapper = ({ children, size = 18, className="" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Save = (p) => <IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>;
        const Trash2 = (p) => <IconWrapper {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconWrapper>;
        const BarChart3 = (p) => <IconWrapper {...p}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></IconWrapper>;
        const Car = (p) => <IconWrapper {...p}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M2 12h12"/></IconWrapper>;
        const Users = (p) => <IconWrapper {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconWrapper>;
        const FileSpreadsheet = (p) => <IconWrapper {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></IconWrapper>;
        const Download = (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconWrapper>;
        const Database = (p) => <IconWrapper {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconWrapper>;
        const Mail = (p) => <IconWrapper {...p}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></IconWrapper>;
        const Settings = (p) => <IconWrapper {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>;
        const Tool = (p) => <IconWrapper {...p}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></IconWrapper>;
        const Plus = (p) => <IconWrapper {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconWrapper>;
        const MapPin = (p) => <IconWrapper {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></IconWrapper>;
        const Clipboard = (p) => <IconWrapper {...p}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></IconWrapper>;
        const X = (p) => <IconWrapper {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconWrapper>;
        const Home = (p) => <IconWrapper {...p}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconWrapper>;

        const Card = ({ children, className = "" }) => (<div className={`bg-white rounded-xl shadow-sm border border-gray-100 p-6 ${className}`}>{children}</div>);
        
        // Utilitários
        const calculateDuration = (start, end) => { 
            if (!start || !end) return 0; 
            const [startH, startM] = start.split(':').map(Number); 
            const [endH, endM] = end.split(':').map(Number); 
            let diff = new Date(0, 0, 0, endH, endM) - new Date(0, 0, 0, startH, startM); 
            if (diff < 0) diff += 86400000; 
            return diff / 3600000; 
        };
        const formatHours = (decimalHours) => { 
            const h = Math.floor(decimalHours); 
            const m = Math.round((decimalHours - h) * 60); 
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`; 
        };
        const formatDatePT = (dateString) => {
            if(!dateString) return "";
            const [y, m, d] = dateString.split('-');
            return `${d}/${m}/${y}`;
        };

        function App() {
            const [activeTab, setActiveTab] = useState('controle');
            const [showConfig, setShowConfig] = useState(false);
            const [toast, setToast] = useState(null);
            
            // Estado do Modal de Relatório
            const [reportModalOpen, setReportModalOpen] = useState(false);
            const [reportType, setReportType] = useState('visitas'); // 'visitas' ou 'admin'
            const reportRef = useRef(null);

            // Dados
            const [costCenters, setCostCenters] = useState([]);
            const [hourBanks, setHourBanks] = useState([]);
            const [visits, setVisits] = useState([]); 
            const [adminEntries, setAdminEntries] = useState([]);

            // Estado para o "Roteiro do Dia"
            const [routeDate, setRouteDate] = useState('');
            const [startPoint, setStartPoint] = useState({ city: '', time: '' });
            const [stops, setStops] = useState([]);
            const [returnPoint, setReturnPoint] = useState({ city: '', time: '', ccId: '' }); // NOVO: Retorno

            const [newAdmin, setNewAdmin] = useState({ data: '', turma: '', atividade: '', inicio: '', fim: '', supervisor: '' });

            const showToast = (msg, type='success') => { setToast({msg, type}); setTimeout(() => setToast(null), 3000); };

            useEffect(() => {
                const init = async () => {
                   if (LINK_FIXO_DO_EXCEL && !LINK_FIXO_DO_EXCEL.includes("SEU_USUARIO")) {
                       try {
                           const resp = await fetch(LINK_FIXO_DO_EXCEL.replace("github.com", "raw.githubusercontent.com").replace("/blob/", "/").replace("/raw/", "/"));
                           if(resp.ok) {
                               const ab = await resp.arrayBuffer();
                               const wb = XLSX.read(ab, { type: 'array' });
                               processWorkbook(wb, 'auto');
                           }
                       } catch(e) { console.log("Erro auto load", e); }
                   }
                };
                init();
            }, []);

            const processWorkbook = (wb, source) => {
                let counts = { cc: 0, banks: 0 };
                
                // 1. Processar CCs
                if (wb.SheetNames.some(n => n.includes("CC"))) {
                    const ws = wb.Sheets[wb.SheetNames.find(n => n.includes("CC"))];
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    const mapped = [];
                    for(let i=1; i < data.length; i++) {
                        const row = data[i];
                        if(row && row.length >= 2) {
                            const turma = row[0];
                            const codigo = row[1];
                            const desc = row[2] || '';
                            if(turma && codigo) mapped.push({ id: i, turma: String(turma).trim(), codigo: String(codigo).trim(), descricao: String(desc).trim() });
                        }
                    }
                    if(mapped.length > 0) {
                        setCostCenters(mapped);
                        counts.cc = mapped.length;
                    }
                }

                // 2. Processar Horas (Aba Específica "CONTROLE DE HORAS POR TURMA PR")
                // Busca por nome exato ou fuzzy
                const horaSheetName = wb.SheetNames.find(n => 
                    n.toUpperCase().trim() === "CONTROLE DE HORAS POR TURMA PR" || 
                    (n.toUpperCase().includes("CONTROLE") && n.toUpperCase().includes("HORAS"))
                );

                if (horaSheetName) {
                    const ws = wb.Sheets[horaSheetName];
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    const mapped = [];
                    // Linha 5 no Excel = índice 4 no array
                    // Coluna A (Turma) = índice 0
                    // Coluna J (Total) = índice 9
                    for(let i=4; i < data.length; i++) {
                        const row = data[i];
                        if(row) {
                            const turma = row[0];
                            const total = row[9];
                            // Validação simples: tem nome de turma e total é numérico
                            if(turma && typeof total === 'number' && total > 0) {
                                mapped.push({ id: i, turma: String(turma).trim(), totalHoras: total });
                            }
                        }
                    }
                    if(mapped.length > 0) {
                        setHourBanks(mapped);
                        counts.banks = mapped.length;
                    }
                }

                if (source === 'manual') showToast(`Sucesso! CCs: ${counts.cc}, Turmas com Horas: ${counts.banks}`);
            };

            const handleManualUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const wb = XLSX.read(evt.target.result, { type: 'binary' });
                    processWorkbook(wb, 'manual');
                };
                reader.readAsBinaryString(file);
            };

            const addStop = () => setStops([...stops, { id: Date.now(), city: '', arrival: '', departure: '', ccId: '' }]);
            const removeStop = (id) => setStops(stops.filter(s => s.id !== id));
            const updateStop = (id, field, value) => setStops(stops.map(s => s.id === id ? { ...s, [field]: value } : s));

            const saveRoute = () => {
                if (!routeDate || !startPoint.city || !startPoint.time) return alert("Preencha data e partida.");
                // Retorno é opcional, mas se preencher cidade, exige horário
                if (returnPoint.city && !returnPoint.time) return alert("Preencha o horário de chegada do retorno.");

                const newEntries = [];
                let lastCity = startPoint.city;
                let lastTime = startPoint.time;

                // Paradas Intermediárias
                stops.forEach(stop => {
                    if (!stop.city || !stop.arrival || !stop.ccId) return;
                    
                    // Deslocamento (Ida até a parada)
                    const travelTime = calculateDuration(lastTime, stop.arrival);
                    if (travelTime > 0) {
                        newEntries.push({
                            id: Date.now() + Math.random(),
                            type: 'deslocamento',
                            data: routeDate,
                            origem: lastCity,
                            destino: stop.city,
                            inicio: lastTime,
                            fim: stop.arrival,
                            turma: stop.ccId,
                            horas: travelTime
                        });
                    }
                    
                    // Atendimento
                    if (stop.departure) {
                        const workTime = calculateDuration(stop.arrival, stop.departure);
                        if (workTime > 0) {
                            newEntries.push({
                                id: Date.now() + Math.random(),
                                type: 'atendimento',
                                data: routeDate,
                                local: stop.city,
                                inicio: stop.arrival,
                                fim: stop.departure,
                                turma: stop.ccId,
                                horas: workTime
                            });
                        }
                        lastTime = stop.departure;
                    } else {
                        lastTime = stop.arrival; 
                    }
                    lastCity = stop.city;
                });

                // Retorno Final (Apenas Deslocamento)
                if (returnPoint.city && returnPoint.time) {
                    const returnTime = calculateDuration(lastTime, returnPoint.time);
                    if (returnTime > 0) {
                        newEntries.push({
                            id: Date.now() + Math.random(),
                            type: 'deslocamento',
                            data: routeDate,
                            origem: lastCity,
                            destino: returnPoint.city,
                            inicio: lastTime,
                            fim: returnPoint.time,
                            turma: returnPoint.ccId || stops[stops.length-1]?.ccId || '', // Usa CC da última parada se não tiver específico
                            horas: returnTime
                        });
                    }
                }

                setVisits([...visits, ...newEntries]);
                showToast(`${newEntries.length} lançamentos gerados!`);
                setStops([]);
                setStartPoint({ city: '', time: '' });
                setReturnPoint({ city: '', time: '', ccId: '' });
            };

            const addAdmin = () => {
                if (!newAdmin.turma || !newAdmin.data) return alert("Preencha dados obrigatórios");
                setAdminEntries([...adminEntries, { ...newAdmin, id: Date.now() }]);
                setNewAdmin({ ...newAdmin, inicio: '', fim: '' });
                showToast("Admin salvo!");
            };

            const copyReportToClipboard = () => {
                if (!reportRef.current) return;
                const range = document.createRange();
                range.selectNode(reportRef.current);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                try {
                    document.execCommand('copy');
                    showToast("Copiado! Cole no Outlook.");
                } catch (err) { alert("Erro ao copiar."); }
                window.getSelection().removeAllRanges();
            };

            const consumptionByClass = useMemo(() => {
                const summary = {};
                hourBanks.forEach(bank => summary[bank.turma] = { total: bank.totalHoras, used: 0, details: { deslocamento: 0, atendimento: 0, admin: 0 } });
                visits.forEach(v => {
                    const ccObj = costCenters.find(c => c.id == v.turma); 
                    const turmaName = ccObj ? ccObj.turma : v.turma;
                    if (summary[turmaName]) {
                        summary[turmaName].used += v.horas;
                        if (v.type === 'deslocamento') summary[turmaName].details.deslocamento += v.horas;
                        if (v.type === 'atendimento') summary[turmaName].details.atendimento += v.horas;
                    }
                });
                adminEntries.forEach(a => {
                     const ccObj = costCenters.find(c => c.turma === a.turma);
                     const turmaName = a.turma;
                     if (summary[turmaName]) {
                         const dur = calculateDuration(a.inicio, a.fim);
                         summary[turmaName].used += dur;
                         summary[turmaName].details.admin += dur;
                     }
                });
                return summary;
            }, [hourBanks, visits, adminEntries, costCenters]);

            const exportData = () => {
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(costCenters), "CC");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(hourBanks), "HORAS");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(visits), "VISITAS");
                XLSX.writeFile(wb, "Backup_Sistema.xlsx");
            };

            const ReportModal = () => {
                if (!reportModalOpen) return null;
                const today = new Date().toLocaleDateString('pt-BR');
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col">
                            <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                                <h3 className="font-bold text-lg text-gray-800">Visualizar Relatório para E-mail</h3>
                                <button onClick={() => setReportModalOpen(false)}><X className="text-gray-500 hover:text-red-500" /></button>
                            </div>
                            
                            <div className="p-6 overflow-y-auto bg-gray-100">
                                <div ref={reportRef} className="print-area font-sans text-gray-800 bg-white">
                                    <div className="senac-header" style={{borderBottom: '2px solid #f97316', paddingBottom: '15px', marginBottom: '20px'}}>
                                        <div>
                                            <h2 style={{fontSize: '24px', fontWeight: 'bold', color: '#004587', margin: 0}}>Relatório de Atividades</h2>
                                            <p style={{color: '#666', margin: 0, fontSize: '14px'}}>Data de Emissão: {today}</p>
                                        </div>
                                        <img src={LOGO_SENAC} alt="Senac" style={{height: '45px'}} />
                                    </div>

                                    {reportType === 'visitas' && (
                                        <div>
                                            <h3 style={{color: '#f97316', fontWeight: 'bold', borderBottom: '1px solid #eee', paddingBottom: '5px'}}>Resumo de Roteiros e Visitas</h3>
                                            <table style={{width: '100%', borderCollapse: 'collapse', marginTop: '10px', fontSize: '12px'}}>
                                                <thead>
                                                    <tr style={{backgroundColor: '#004587', color: 'white'}}>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Data</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Tipo / Info Senac</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Detalhes</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Horários</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Turma/CC</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a', textAlign: 'right'}}>Horas</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {visits.map((v, i) => {
                                                        const cc = costCenters.find(c => c.id == v.turma);
                                                        const ccCodigo = cc ? cc.codigo : '-';
                                                        const turmaNome = cc ? cc.turma : 'N/A';
                                                        const rowBg = i % 2 === 0 ? '#ffffff' : '#f8fafc';
                                                        
                                                        // Infos SENAC
                                                        const info = v.type === 'deslocamento' ? INFO_DESLOCAMENTO : INFO_ATENDIMENTO;
                                                        
                                                        return (
                                                            <tr key={i} style={{backgroundColor: rowBg}}>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0'}}>{formatDatePT(v.data)}</td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0'}}>
                                                                    <div style={{fontWeight:'bold', color: v.type==='deslocamento'?'#d97706':'#15803d'}}>{v.type.toUpperCase()}</div>
                                                                    <div style={{fontSize:'10px', color:'#555', marginTop:'4px'}}>
                                                                        UEPT: {info.uept} | TEPT: {info.tept}<br/>
                                                                        Evento: <b>{info.evento}</b>
                                                                    </div>
                                                                </td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0'}}>
                                                                    {v.type === 'deslocamento' ? 
                                                                        <span>{v.origem} &#10140; {v.destino}</span> : 
                                                                        <span>Atend. em {v.local}</span>
                                                                    }
                                                                </td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0', whiteSpace:'nowrap'}}>
                                                                    {v.type === 'deslocamento' ? 
                                                                        <div>Saída: {v.inicio}<br/>Chegada: {v.fim}</div> : 
                                                                        <div>Início: {v.inicio}<br/>Fim: {v.fim}</div>
                                                                    }
                                                                </td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0'}}>
                                                                    <div>{turmaNome}</div>
                                                                    <div style={{fontFamily: 'monospace', fontWeight: 'bold', color:'#004587'}}>{ccCodigo}</div>
                                                                </td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0', textAlign: 'right', fontWeight: 'bold'}}>{formatHours(v.horas)}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}

                                    {reportType === 'admin' && (
                                        <div>
                                            <h3 style={{color: '#f97316', fontWeight: 'bold', borderBottom: '1px solid #eee', paddingBottom: '5px'}}>Lançamentos Administrativos</h3>
                                            <table style={{width: '100%', borderCollapse: 'collapse', marginTop: '10px', fontSize: '12px'}}>
                                                <thead>
                                                    <tr style={{backgroundColor: '#004587', color: 'white'}}>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Data</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Info Senac</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Atividade</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Horários</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a'}}>Turma/CC</th>
                                                        <th style={{padding: '8px', border: '1px solid #00366a', textAlign: 'right'}}>Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {adminEntries.map((a, i) => {
                                                        const cc = costCenters.find(c => c.turma === a.turma);
                                                        const ccCodigo = cc ? cc.codigo : '-';
                                                        const rowBg = i % 2 === 0 ? '#ffffff' : '#f8fafc';
                                                        return (
                                                            <tr key={i} style={{backgroundColor: rowBg}}>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0'}}>{formatDatePT(a.data)}</td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0', fontSize:'10px', color:'#555'}}>
                                                                    UEPT: {INFO_ATENDIMENTO.uept} | TEPT: {INFO_ATENDIMENTO.tept}<br/>
                                                                    Evento: <b>{INFO_ATENDIMENTO.evento}</b>
                                                                </td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0'}}>{a.atividade}</td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0', whiteSpace:'nowrap'}}>Início: {a.inicio}<br/>Fim: {a.fim}</td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0'}}>
                                                                    <div>{a.turma}</div>
                                                                    <div style={{fontFamily: 'monospace', fontWeight: 'bold', color:'#004587'}}>{ccCodigo}</div>
                                                                </td>
                                                                <td style={{padding: '8px', border: '1px solid #e2e8f0', textAlign: 'right', fontWeight: 'bold'}}>{formatHours(calculateDuration(a.inicio, a.fim))}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="p-4 border-t bg-white rounded-b-xl flex justify-end gap-3">
                                <button onClick={() => setReportModalOpen(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Fechar</button>
                                <button onClick={copyReportToClipboard} className="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 flex items-center gap-2 shadow-md">
                                    <Clipboard size={18} /> Copiar para Outlook
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderVisitas = () => (
                <div className="space-y-6">
                    <Card className="border-l-4 border-blue-500">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg flex items-center gap-2"><MapPin className="text-blue-600"/> Criador de Roteiro Diário</h3>
                            <input type="date" className="p-2 border rounded font-bold text-gray-700" value={routeDate} onChange={e => setRouteDate(e.target.value)} />
                        </div>
                        
                        {/* Partida */}
                        <div className="p-4 bg-gray-50 rounded-lg mb-4 border border-gray-200">
                            <h4 className="text-xs font-bold text-gray-500 uppercase mb-2">1. Ponto de Partida</h4>
                            <div className="grid grid-cols-2 gap-4">
                                <input type="text" placeholder="Cidade Origem" className="p-2 border rounded" value={startPoint.city} onChange={e => setStartPoint({...startPoint, city: e.target.value})} />
                                <input type="time" className="p-2 border rounded" value={startPoint.time} onChange={e => setStartPoint({...startPoint, time: e.target.value})} />
                            </div>
                        </div>

                        {/* Paradas */}
                        <div className="space-y-3 mb-4">
                            {stops.map((stop, idx) => (
                                <div key={stop.id} className="p-4 bg-white border border-blue-100 rounded-lg shadow-sm relative">
                                    <div className="absolute -left-3 top-1/2 -translate-y-1/2 bg-blue-100 text-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">{idx+1}</div>
                                    <button onClick={() => removeStop(stop.id)} className="absolute top-2 right-2 text-red-400 hover:text-red-600"><Trash2 size={16}/></button>
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                        <div><label className="text-xs text-gray-500">Cidade Destino</label><input type="text" className="w-full p-2 border rounded" value={stop.city} onChange={e => updateStop(stop.id, 'city', e.target.value)} /></div>
                                        <div><label className="text-xs text-gray-500">Chegada</label><input type="time" className="w-full p-2 border rounded" value={stop.arrival} onChange={e => updateStop(stop.id, 'arrival', e.target.value)} /></div>
                                        <div><label className="text-xs text-gray-500">Saída (Fim atend.)</label><input type="time" className="w-full p-2 border rounded" value={stop.departure} onChange={e => updateStop(stop.id, 'departure', e.target.value)} /></div>
                                        <div><label className="text-xs text-gray-500">Turma/CC</label><select className="w-full p-2 border rounded text-sm" value={stop.ccId} onChange={e => updateStop(stop.id, 'ccId', e.target.value)}><option value="">Selecione...</option>{costCenters.map(cc => (<option key={cc.id} value={cc.id}>{cc.turma} - {cc.codigo}</option>))}</select></div>
                                    </div>
                                </div>
                            ))}
                            <button onClick={addStop} className="w-full py-2 border-2 border-dashed border-blue-300 text-blue-600 rounded-lg hover:bg-blue-50 font-semibold flex justify-center items-center gap-2"><Plus size={18}/> Adicionar Parada/Atendimento</button>
                        </div>

                        {/* Retorno */}
                        <div className="p-4 bg-orange-50 rounded-lg mb-4 border border-orange-200">
                            <h4 className="text-xs font-bold text-orange-600 uppercase mb-2 flex items-center gap-1"><Home size={14}/> Retorno à Base / Final (Apenas Deslocamento)</h4>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label className="text-xs text-gray-500">Cidade Final</label><input type="text" className="w-full p-2 border rounded" value={returnPoint.city} onChange={e => setReturnPoint({...returnPoint, city: e.target.value})} /></div>
                                <div><label className="text-xs text-gray-500">Chegada</label><input type="time" className="w-full p-2 border rounded" value={returnPoint.time} onChange={e => setReturnPoint({...returnPoint, time: e.target.value})} /></div>
                                <div>
                                    <label className="text-xs text-gray-500">CC do Deslocamento (Opcional)</label>
                                    <select className="w-full p-2 border rounded text-sm" value={returnPoint.ccId} onChange={e => setReturnPoint({...returnPoint, ccId: e.target.value})}>
                                        <option value="">Usar CC da última parada</option>
                                        {costCenters.map(cc => (<option key={cc.id} value={cc.id}>{cc.turma}</option>))}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <button onClick={saveRoute} className="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold flex justify-center items-center gap-2 shadow-lg"><Save size={18}/> Salvar Roteiro Completo</button>
                    </Card>

                    <Card>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-gray-700">Histórico de Atividades</h3>
                            <button onClick={() => { setReportType('visitas'); setReportModalOpen(true); }} className="text-sm bg-orange-500 text-white px-3 py-1 rounded hover:bg-orange-600 flex items-center gap-1 shadow"><Mail size={14}/> Relatório E-mail</button>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left table-tiny">
                                <thead className="bg-gray-100 text-gray-600"><tr><th>Data</th><th>Tipo</th><th>Detalhe</th><th>Horários</th><th>Turma</th><th>CC</th><th>Horas</th><th></th></tr></thead>
                                <tbody>{visits.map(v => {
                                    const cc = costCenters.find(c => c.id == v.turma);
                                    const turma = cc ? cc.turma : 'N/A';
                                    const cod = cc ? cc.codigo : '-';
                                    return (
                                        <tr key={v.id} className="border-b hover:bg-gray-50">
                                            <td>{formatDatePT(v.data)}</td>
                                            <td>{v.type === 'deslocamento' ? <span className="text-yellow-600 font-bold text-xs">Desloc.</span> : <span className="text-green-600 font-bold text-xs">Atend.</span>}</td>
                                            <td className="text-gray-600 text-xs">{v.type === 'deslocamento' ? `${v.origem} > ${v.destino}` : v.local}</td>
                                            <td className="text-xs whitespace-nowrap">{v.type==='deslocamento' ? `Saída: ${v.inicio} Cheg: ${v.fim}` : `Início: ${v.inicio} Fim: ${v.fim}`}</td>
                                            <td className="text-xs">{turma}</td>
                                            <td className="text-xs font-mono text-blue-600">{cod}</td>
                                            <td className="font-bold text-xs">{formatHours(v.horas)}</td>
                                            <td><button onClick={() => setVisits(visits.filter(x => x.id !== v.id))} className="text-red-400"><Trash2 size={14}/></button></td>
                                        </tr>
                                    );
                                })}</tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            );

            const renderControle = () => (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {hourBanks.length === 0 && <div className="col-span-full p-8 text-center bg-gray-100 rounded-lg text-gray-500">Nenhum controle de horas carregado. Verifique se a planilha "CONTROLE DE HORAS POR TURMA PR" existe e possui dados na linha 5.</div>}
                    {hourBanks.map(bank => {
                        const stats = consumptionByClass[bank.turma] || { used: 0, total: bank.totalHoras };
                        const percentage = bank.totalHoras > 0 ? Math.min((stats.used / bank.totalHoras) * 100, 100) : 0;
                        const saldo = bank.totalHoras - stats.used;
                        return (
                            <Card key={bank.id} className="border-l-4 border-l-blue-500">
                                <div className="flex justify-between items-start mb-2"><div><h3 className="font-bold text-lg">{bank.turma}</h3><p className="text-xs text-gray-500">Meta: {formatHours(bank.totalHoras)}h</p></div></div>
                                <div className="w-full bg-gray-200 rounded-full h-2 mt-2"><div className={`h-2 rounded-full ${saldo < 0 ? 'bg-red-500' : 'bg-blue-600'}`} style={{ width: `${percentage}%` }}></div></div>
                                <div className="flex justify-between text-xs mt-2 font-medium"><span className="text-gray-600">Usado: {formatHours(stats.used)}h</span><span className={saldo < 0 ? 'text-red-600' : 'text-green-600'}>Saldo: {formatHours(saldo)}h</span></div>
                            </Card>
                        );
                    })}
                </div>
            );

            const renderAdmin = () => (
                <div className="space-y-6">
                    <Card>
                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Users className="text-purple-600"/> Lançamento Administrativo</h3>
                        <div className="grid grid-cols-1 gap-4 mb-4">
                            <input type="date" className="p-2 border rounded" value={newAdmin.data} onChange={e => setNewAdmin({...newAdmin, data: e.target.value})} />
                            <select className="p-2 border rounded" value={newAdmin.turma} onChange={e => setNewAdmin({...newAdmin, turma: e.target.value})}><option value="">Selecione Turma...</option>{costCenters.map(cc => <option key={cc.id} value={cc.turma}>{cc.turma}</option>)}</select>
                            <input type="text" placeholder="Atividade" className="p-2 border rounded" value={newAdmin.atividade} onChange={e => setNewAdmin({...newAdmin, atividade: e.target.value})} />
                            <div className="flex gap-4"><input type="time" className="p-2 border rounded flex-1" value={newAdmin.inicio} onChange={e => setNewAdmin({...newAdmin, inicio: e.target.value})} /><input type="time" className="p-2 border rounded flex-1" value={newAdmin.fim} onChange={e => setNewAdmin({...newAdmin, fim: e.target.value})} /></div>
                        </div>
                        <button onClick={addAdmin} className="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700 flex justify-center items-center gap-2"><Save size={18} /> Salvar</button>
                    </Card>
                    <Card>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-gray-700">Histórico Admin</h3>
                            <button onClick={() => { setReportType('admin'); setReportModalOpen(true); }} className="text-sm bg-orange-500 text-white px-3 py-1 rounded hover:bg-orange-600 flex items-center gap-1 shadow"><Mail size={14}/> Relatório E-mail</button>
                        </div>
                        <table className="w-full text-sm text-left"><thead className="bg-gray-100"><tr><th className="p-2">Data</th><th className="p-2">Ativ.</th><th className="p-2">Turma</th><th className="p-2">CC</th><th className="p-2">Horários</th><th className="p-2">Total</th><th></th></tr></thead>
                        <tbody>{adminEntries.map(a => {
                            const cc = costCenters.find(c => c.turma === a.turma);
                            const ccCodigo = cc ? cc.codigo : '-';
                            return (<tr key={a.id} className="border-b"><td className="p-2">{formatDatePT(a.data)}</td><td className="p-2">{a.atividade}</td><td className="p-2">{a.turma}</td><td className="p-2 font-mono text-blue-600 text-xs">{ccCodigo}</td><td className="p-2 text-xs">Início: {a.inicio} Fim: {a.fim}</td><td className="p-2 font-bold">{formatHours(calculateDuration(a.inicio, a.fim))}</td><td><button onClick={() => setAdminEntries(adminEntries.filter(x => x.id !== a.id))} className="text-red-400"><Trash2 size={14}/></button></td></tr>);
                        })}</tbody></table>
                    </Card>
                </div>
            );

            const renderCC = () => (
                <Card>
                    <h3 className="font-bold text-lg mb-4">Centros de Custo (Carregados)</h3>
                    <div className="overflow-x-auto max-h-96">
                        <table className="w-full text-left border-collapse text-sm">
                            <thead><tr className="bg-gray-100 sticky top-0"><th className="p-2 border-b">Turma (Col A)</th><th className="p-2 border-b">CC (Col B)</th><th className="p-2 border-b">Descrição</th></tr></thead>
                            <tbody>{costCenters.map(cc => <tr key={cc.id} className="border-b hover:bg-gray-50"><td className="p-2 font-bold text-gray-700">{cc.turma}</td><td className="p-2 font-mono text-blue-600">{cc.codigo}</td><td className="p-2 text-gray-500">{cc.descricao}</td></tr>)}</tbody>
                        </table>
                    </div>
                </Card>
            );

            return (
                <div className="min-h-screen bg-gray-50 p-4 md:p-8 font-sans text-gray-800">
                    {toast && <div className={`toast ${toast.type === 'error' ? 'toast-error' : 'toast-success'}`}>{toast.msg}</div>}
                    <ReportModal />
                    
                    <div className="max-w-6xl mx-auto mb-6">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                            <div><h1 className="text-2xl font-bold text-gray-900">Sistema de Rateio</h1><p className="text-gray-500 text-sm">Gestão de Horas e Roteiros</p></div>
                            <div className="flex gap-2">
                                <button onClick={() => setShowConfig(!showConfig)} className="bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300 flex items-center gap-2"><Settings size={18} /> Dados</button>
                                <button onClick={exportData} className="bg-green-700 text-white px-4 py-2 rounded-lg shadow hover:bg-green-800 flex items-center gap-2"><Download size={18} /> Backup</button>
                            </div>
                        </div>

                        {showConfig && (
                            <Card className="mb-6 bg-slate-50 border-slate-200">
                                <h4 className="font-bold text-gray-800 mb-2 flex items-center gap-2"><FileSpreadsheet size={18}/> Importar Planilha Mestra</h4>
                                <p className="text-xs text-gray-500 mb-2">Importe o arquivo RATEIO.xlsm para atualizar CCs e Horas.</p>
                                <div className="relative"><input type="file" accept=".xlsx,.xlsm" onChange={handleManualUpload} className="absolute inset-0 w-full opacity-0 cursor-pointer" /><button className="w-full bg-white border border-gray-300 text-gray-700 py-2 rounded text-xs font-bold hover:bg-gray-50">Selecionar Arquivo</button></div>
                            </Card>
                        )}
                    </div>

                    <div className="max-w-6xl mx-auto bg-white rounded-lg shadow-sm p-1 mb-6 flex overflow-x-auto">
                        {[{ id: 'controle', icon: BarChart3, label: 'Painel Geral' }, { id: 'visitas', icon: Car, label: 'Lançar Visitas' }, { id: 'admin', icon: Users, label: 'Lançar Admin' }, { id: 'cc', icon: Database, label: 'Ver CCs' }].map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 flex items-center justify-center gap-2 py-3 px-4 rounded-md transition-all whitespace-nowrap ${activeTab === tab.id ? 'bg-blue-50 text-blue-600 font-bold shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}>
                                <tab.icon size={18} /> {tab.label}
                            </button>
                        ))}
                    </div>

                    <div className="max-w-6xl mx-auto">
                        {activeTab === 'controle' && renderControle()}
                        {activeTab === 'visitas' && renderVisitas()}
                        {activeTab === 'admin' && renderAdmin()}
                        {activeTab === 'cc' && renderCC()}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
